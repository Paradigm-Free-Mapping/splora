# Python CircleCI 2.1 configuration file
version: 2.1

orbs:
  codecov: codecov/codecov@4.0.1

jobs:
  lint:
    docker:
      - image: cimg/python:3.10
    working_directory: ~/src/splora
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
      - run:
          name: Create virtual environment and install dependencies
          command: |
            uv venv
            uv sync --all-extras
      - run:
          name: Run linting
          command: |
            uv run ruff check splora

  unit_tests:
    parameters:
      python_version:
        type: string
    docker:
      - image: cimg/python:<< parameters.python_version >>
    working_directory: ~/src/splora
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
      - run:
          name: Create virtual environment and install dependencies
          command: |
            uv venv
            uv sync --all-extras
      - run:
          name: Run unit tests
          command: |
            uv run pytest --skipintegration --cov-append --cov-report=xml --cov=splora splora/
      - store_artifacts:
          path: coverage.xml
      - codecov/upload:
          file: coverage.xml

  integration_tests:
    parameters:
      python_version:
        type: string
    docker:
      - image: cimg/python:<< parameters.python_version >>
    working_directory: ~/src/splora
    steps:
      - checkout
      - run:
          name: Install AFNI
          command: |
            sudo apt-get update
            sudo apt-get install -y curl tcsh libxp6 libxpm4 libxmu6 gsl-bin netpbm xvfb
            curl -O https://afni.nimh.nih.gov/pub/dist/bin/misc/@update.afni.binaries
            tcsh @update.afni.binaries -package linux_ubuntu_16_64 -do_extras -bindir ~/abin
            echo 'export PATH=$HOME/abin:$PATH' >> $BASH_ENV
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
      - run:
          name: Create virtual environment and install dependencies
          command: |
            uv venv
            uv sync --all-extras
      - run:
          name: Run integration tests
          command: |
            uv run pytest --cov-append --cov-report=xml --cov=splora splora/tests/test_integration.py
      - store_artifacts:
          path: coverage.xml
      - codecov/upload:
          file: coverage.xml

workflows:
  version: 2
  build_test:
    jobs:
      - lint
      - unit_tests:
          name: unit-py310
          python_version: "3.10"
          requires:
            - lint
      - unit_tests:
          name: unit-py311
          python_version: "3.11"
          requires:
            - lint
      - unit_tests:
          name: unit-py312
          python_version: "3.12"
          requires:
            - lint
      - unit_tests:
          name: unit-py313
          python_version: "3.13"
          requires:
            - lint
      - integration_tests:
          name: integration-py310
          python_version: "3.10"
          requires:
            - lint
      - integration_tests:
          name: integration-py311
          python_version: "3.11"
          requires:
            - lint
      - integration_tests:
          name: integration-py312
          python_version: "3.12"
          requires:
            - lint
      - integration_tests:
          name: integration-py313
          python_version: "3.13"
          requires:
            - lint
